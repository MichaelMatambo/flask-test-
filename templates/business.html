<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InjectaReview - Business Center</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    
    <style>
        /* --- 1. Universal Reset and Typography (From style.css) --- */
        * { 
            box-sizing: border-box; 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        html, body { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            line-height: 1.6;
            color: #333; 
            background-color: #f5f5f5; 
            /* allow scrolling only on the main wrapper for the fixed map layout */
            overflow: hidden; 
        }

        a {
            color: #0073bb; /* Brand Blue */
            text-decoration: none;
            transition: color 0.2s;
        }

        a:hover {
            color: #005a96; /* Darker Brand Blue */
            text-decoration: underline;
        }

        h1, h2, h3 {
            color: #333;
            margin-bottom: 0.5em;
        }

        /* --- 2. Header (Navbar) Style (From style.css) --- */
        .header {
            background-color: #0073bb; /* Brand Primary Blue */
            color: white;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
            margin-right: 30px;
        }

        .header .nav-links {
            display: flex;
            align-items: center;
        }

        .header .nav-links a {
            color: white;
            margin-left: 20px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .header .nav-links a:hover,
        .header .nav-links a.active {
            background-color: #005a96; 
            text-decoration: none;
        }

        /* --- 3. Page Structure and Layout (business.html specific) --- */
        
        /* Main wrapper now fills remaining space after header/footer */
        .main-wrapper { 
            padding: 20px 50px;
            height: calc(100vh - 120px); /* Adjust height based on header/footer height */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .page-title-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px;
            flex-shrink: 0;
        }
        
        .content-area { 
            display: flex; 
            gap: 20px; 
            flex-grow: 1; 
            min-height: 0; 
        }
        
        .left-panel {
            width: 450px; 
            overflow-y: auto; 
            padding-right: 15px;
            flex-shrink: 0;
            position: relative;
            /* Scrollbar styling for a cleaner look */
            scrollbar-width: thin; 
            scrollbar-color: #0073bb #f0f0f0;
        }
        .left-panel::-webkit-scrollbar { width: 8px; }
        .left-panel::-webkit-scrollbar-thumb { background-color: #0073bb; border-radius: 10px; }
        .left-panel::-webkit-scrollbar-track { background: #f0f0f0; }

        .map-panel {
            flex-grow: 1;
            height: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); 
        }

        /* --- 4. Form & Section Styles --- */

        h1 { color: #0073bb; margin: 0; } 
        .user-info { font-size: 1.1em; font-weight: bold; color: white;}
        .section { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); margin-bottom: 20px; }
        .section h2 { margin-top: 0; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

        label { 
            display: block; 
            margin-bottom: 4px; 
            font-weight: bold; 
            margin-top: 15px; 
            font-size: 0.95em;
            color: #555;
        }
        input[type="text"], input[type="search"], input[type="tel"], input[type="number"] { 
            width: 100%; 
            padding: 10px 12px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s;
        }
        input:focus {
            border-color: #0073bb; 
            outline: none;
        }
        
        /* Primary Button Style (Brand Blue) */
        button[type="submit"], button#registerBtn { 
            background-color: #0073bb; 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin-top: 15px; 
            font-size: 16px; 
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 100%; 
        }
        button[type="submit"]:hover, button#registerBtn:hover { 
            background-color: #005a94; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }

        .details-button { 
            width: auto !important; /* Override the 100% width */
            margin-left: 0; 
            margin-top: 5px; 
            background-color: #0073bb; 
            padding: 8px 15px;
            font-size: 14px;
        }
        .details-button:hover {
            background-color: #005a94;
        }

        /* Collapsible Form Styling */
        .form-content-wrapper {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .collapsed .form-content-wrapper {
            max-height: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }
        .form-toggle-link {
            font-weight: bold;
            color: #0073bb;
            cursor: pointer;
            text-decoration: none;
            padding: 5px 0;
            transition: color 0.2s;
        }
        
        /* Fixed "Add Business" Button */
        #fixedAddBusinessBtn {
            position: sticky; 
            bottom: 20px;
            width: 100%;
            z-index: 500;
            display: none; 
            margin-top: 0; 
            background-color: #0073bb; 
        }

        /* Message Styling */
        .map-instruction { background-color: #fff8e1; color: #666; padding: 10px; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid #ffc107; font-size: 0.9em; }
        .message { margin-top: 20px; padding: 10px; border-radius: 4px; font-weight: bold; display: none; }
        .success { background-color: #e6ffed; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8e6e6; color: #721c24; border: 1px solid #f5c6cb; }
        .rating { font-weight: bold; color: #ff9800; font-size: 1.1em;}

        /* Business List */
        .business-list { list-style: none; padding: 0; margin: 0; }
        .business-item { border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 6px; transition: background-color 0.2s; background: white; border-left: 4px solid #0073bb; }
        .business-item h3 { margin-top: 0; color: #0073bb; } 
        
        /* --- 5. Map & OpenLayers Styles --- */

        #map { 
            height: 100%; 
            width: 100%; 
            border-radius: 6px; 
            border: 2px solid #0073bb; 
            position: relative; 
        }

        .ol-zoom { top: 20px; left: 20px; z-index: 101; background-color: transparent !important; }
        .ol-zoom .ol-control button {
            background-color: rgba(255, 255, 255, 0.9) !important;
            color: #0073bb; 
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        
        .ol-custom-layer-switcher {
            top: 20px; right: 20px; position: absolute; padding: 10px;
            background-color: rgba(255,255,255,0.95); border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; 
        }
        .ol-custom-layer-switcher label { display: block; font-weight: normal; font-size: 0.9em; margin: 4px 0; cursor: pointer; }
        
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 250px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            font-size: 1.2em;
            color: #999;
        }
        .ol-popup-closer:after {
            content: "‚úñ";
        }
        .ol-popup h4 { margin-top: 0; margin-bottom: 5px; color: #0073bb;}
        .ol-popup p { margin: 0; font-size: 0.9em; color: #555; }
        .ol-popup button { width: auto; margin-top: 8px; padding: 6px 12px; font-size: 13px; }


        /* --- 6. Footer Style (From style.css) --- */
        .footer {
            background-color: #333; 
            color: white;
            padding: 10px 50px; /* Reduced padding for compact footer */
            text-align: center;
            font-size: 0.9em;
            flex-shrink: 0;
            line-height: 1.5;
        }

        /* --- 7. Responsiveness --- */
        @media (max-width: 1200px) {
            html, body { overflow: auto; }
            .header, .main-wrapper, .footer { padding-left: 20px; padding-right: 20px; }
            .main-wrapper { height: auto; }
            .content-area { flex-direction: column; height: auto; gap: 10px; }
            .left-panel { width: 100%; padding-right: 0; overflow-y: visible; min-height: auto; }
            .map-panel { width: 100%; height: 400px; position: static; }
            #fixedAddBusinessBtn { position: static; box-shadow: none; margin-top: 20px; }
        }
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <header class="header">
        <div class="logo">InjectaReview</div>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="business.html" class="active">Browse</a>
            <a href="#" onclick="alert('TODO: Implement User Profile')">Profile</a>
            <div class="user-info" style="margin-left: 30px;">
                <span id="userDisplay">Guest</span> (<a href="index.html">Logout</a>)
            </div>
        </nav>
    </header>

    <div class="main-wrapper">
        <div class="page-title-bar">
            <h1>üó∫Ô∏è Business Center: ZIMBABWE</h1>
            </div>

        <div class="content-area">
            
            <div class="left-panel">
                
                <div class="section">
                    <h2>üîç Find Businesses</h2>
                    <form id="searchForm">
                        <label for="search-term">Search Term (Name/Address):</label>
                        <input type="search" id="search-term" placeholder="e.g., Joe's Pizza">

                        <label for="city-filter">City Filter:</label>
                        <input type="text" id="city-filter" placeholder="e.g., Harare, Bulawayo">
                        
                        <label for="category-filter">Category:</label>
                        <input type="text" id="category-filter" placeholder="e.g., Restaurant">
                        
                        <button type="submit">Search Businesses</button>
                    </form>
                </div>

                <div class="section">
                    <h2>Search Results</h2>
                    <div id="resultsMessage" class="message"></div>
                    <ul id="businessList" class="business-list">
                        <li style="padding: 20px; text-align: center; color: #999; border-left: none;">
                            Use the search form above to find businesses.
                        </li>
                    </ul>
                </div>

                <div id="registrationSection" class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h2>‚ûï Register a New Business</h2>
                        <a href="#" class="form-toggle-link" onclick="toggleRegistrationForm(event)">Collapse</a>
                    </div>
                    
                    <div class="map-instruction">
                        üìç <strong>Click anywhere on the map (right)</strong> to set the business location.
                    </div>

                    <div id="registrationFormContent" class="form-content-wrapper">
                        <form id="registerBusinessForm">
                            <label for="biz-name">Business Name: *</label>
                            <input type="text" id="biz-name" placeholder="e.g., Tony's Pizzeria" required>

                            <label for="biz-address">Street Address: *</label>
                            <input type="text" id="biz-address" placeholder="e.g., 123 Main Street" required>
                            
                            <label for="biz-city">City: *</label>
                            <input type="text" id="biz-city" placeholder="e.g., Harare" required>

                            <label for="biz-state">State/Province: *</label>
                            <input type="text" id="biz-state" placeholder="e.g., Harare Province" required>

                            <label for="biz-zip">Zip Code: *</label>
                            <input type="text" id="biz-zip" placeholder="e.g., 00263" required>

                            <label for="biz-category">Categories (comma-separated): *</label>
                            <input type="text" id="biz-category" placeholder="e.g., Pizza, Italian, Restaurant" required>

                            <label for="biz-phone">Phone Number: *</label>
                            <input type="tel" id="biz-phone" placeholder="e.g., (263) 123-4567" required>

                            <label for="biz-latitude">Latitude: *</label>
                            <input type="text" id="biz-latitude" readonly placeholder="Click map to set location" required>

                            <label for="biz-longitude">Longitude: *</label>
                            <input type="text" id="biz-longitude" readonly placeholder="Click map to set location" required>

                            <button type="submit" id="registerBtn" title="Please log in to register businesses">Register Business</button>
                        </form>
                    </div>
                </div>

                <button id="fixedAddBusinessBtn" onclick="toggleRegistrationForm(null, 'expand')">
                    ‚ûï Add Business Location
                </button>

                <div id="singleBusinessView" class="section" style="display:none;">
                    <button onclick="closeSingleView()" style="float: right; background: #999; width: auto; padding: 6px 12px; margin-top: 0;">‚úï Close</button>
                    <h2 id="singleBizName"></h2>
                    <p><strong>Rating:</strong> <span id="singleBizRating" class="rating"></span> ‚≠ê (<span id="singleBizReviewCount"></span> reviews)</p>
                    <p><strong>Address:</strong> <span id="singleBizAddress"></span></p>
                    <p><strong>Category:</strong> <span id="singleBizCategory"></span></p>
                    <p><strong>Phone:</strong> <span id="singleBizPhone"></span></p>
                    
                    <h3>üìù Customer Reviews</h3>
                    <ul id="reviewsList" class="business-list"></ul>

                    <div id="reviewFormSection">
                        <h4>Write Your Review</h4>
                        <div id="reviewAuthMessage" class="map-instruction" style="display:none;">
                            You must be logged in to post a review.
                        </div>
                        <form id="submitReviewForm">
                            <input type="hidden" id="review-business-id">
                            <label for="review-rating">Rating (1-5 stars): *</label>
                            <input type="number" id="review-rating" min="1" max="5" required style="width: 100px;">
                            <label for="review-text">Your Review: *</label>
                            <input type="text" id="review-text" placeholder="Share your experience..." required>
                            <button type="submit">Post Review</button>
                        </form>
                        <div id="reviewMessage" class="message"></div>
                    </div>
                </div>

            </div>

            <div class="map-panel">
                <div id="map"></div>
                
                <div id="popup" class="ol-popup">
                    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                    <div id="popup-content"></div>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 InjectaReview. Powered by Injecta Analytics.</p>
    </footer>

    <script>
        // Use ol namespace for OpenLayers
        const { Map, View, layer, source, Feature, geom, style, proj, control, interaction, Overlay } = ol;
        
        // --- API Configuration & Category Icons ---
        const API_URL = 'http://127.0.0.1:5000/api';

        // Category to Emoji Mapping for Map Icons
        const categoryIcons = {
            'restaurant': 'üçî', 'pizza': 'üçï', 'italian': 'üçù', 'coffee': '‚òï', 'cafe': '‚òï', 'bar': 'üçª',
            'night club': 'üé∂', 'hotel': 'üè®', 'lodge': 'üõéÔ∏è', 'grocery': 'üõí', 'supermarket': 'üõí', 
            'hardware': 'üõ†Ô∏è', 'electronics': 'üì∫', 'furniture': 'üõãÔ∏è', 'clothing': 'üëó', 'pharmacy': '‚öïÔ∏è', 
            'clinic': 'üè•', 'hospital': 'üè•', 'education': 'üìö', 'fuel station': '‚õΩ', 'car sale': 'üöó', 
            'barber': 'üíá', 'salon': 'üíÖ', 'church': '‚õ™', 'default': 'üè¢' // Default icon for all others
        };

        let map;
        let vectorSource, clusterSource, vectorLayer;
        let tempRegistrationFeature;
        
        // Coordinates for Zimbabwe center (Harare)
        const ZIMBABWE_CENTER_LON = 31.0530; 
        const ZIMBABWE_CENTER_LAT = -17.8248; 
        const ZIMBABWE_INITIAL_ZOOM = 10;
        const defaultCenter = proj.fromLonLat([ZIMBABWE_CENTER_LON, ZIMBABWE_CENTER_LAT]);

        // --- AUTHENTICATION & UI HELPERS ---

        /**
         * Reads the token from localStorage and updates the UI (Logout link, button states).
         */
        function checkAuthAndDisplay() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username') || 'Guest';
            const userDisplay = document.getElementById('userDisplay');
            const registerBtn = document.getElementById('registerBtn');
            const reviewAuthMessage = document.getElementById('reviewAuthMessage');

            userDisplay.textContent = username;
            
            if (token) {
                // User is logged in
                if (registerBtn) {
                    registerBtn.removeAttribute('disabled');
                    registerBtn.removeAttribute('title');
                }
                if (reviewAuthMessage) reviewAuthMessage.style.display = 'none';
                document.getElementById('reviewFormSection').style.display = 'block';
            } else {
                // User is a guest
                if (registerBtn) {
                    registerBtn.setAttribute('disabled', 'true');
                    registerBtn.setAttribute('title', 'Please log in to register businesses');
                }
                if (reviewAuthMessage) reviewAuthMessage.style.display = 'block';
                document.getElementById('reviewFormSection').style.display = 'none';
            }
        }
        
        /**
         * Toggles the display of a message element.
         * @param {string} id - The ID of the message container element.
         * @param {string} type - 'success' or 'error'.
         * @param {string} message - The message text.
         */
        function displayMessage(id, type, message) {
            const element = document.getElementById(id);
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        /**
         * Toggles the business registration form visibility.
         * @param {Event} event - The click event (optional).
         * @param {string} forceState - 'expand' or 'collapse' (optional).
         */
        function toggleRegistrationForm(event, forceState) {
            if (event) event.preventDefault();

            const section = document.getElementById('registrationSection');
            const link = section.querySelector('.form-toggle-link');
            const fixedBtn = document.getElementById('fixedAddBusinessBtn');
            const isCollapsed = section.classList.contains('collapsed');

            let newState = isCollapsed;
            if (forceState === 'expand') {
                newState = false;
            } else if (forceState === 'collapse') {
                newState = true;
            }

            if (newState) {
                section.classList.add('collapsed');
                link.textContent = 'Expand';
                fixedBtn.style.display = 'block';
            } else {
                section.classList.remove('collapsed');
                link.textContent = 'Collapse';
                fixedBtn.style.display = 'none';
            }
        }

        // --- MAP FUNCTIONS (STYLES, INTERACTION) ---
        
        /**
         * Gets the appropriate emoji for the business category.
         * @param {string} categoryString - Comma-separated categories.
         */
        function getCategoryEmoji(categoryString) {
            if (!categoryString) return categoryIcons.default;
            const categories = categoryString.toLowerCase().split(',').map(c => c.trim());
            
            for (const category of categories) {
                if (categoryIcons[category]) {
                    return categoryIcons[category];
                }
            }
            return categoryIcons.default;
        }

        /**
         * Creates the OpenLayers style for a single business marker.
         * @param {Feature} feature - The OpenLayers feature.
         */
        function createBusinessStyle(feature) {
            const businessData = feature.get('businessData');
            const category = businessData ? businessData.categories || '' : '';
            const emoji = getCategoryEmoji(category);
            const rating = businessData ? (businessData.avg_rating || 0).toFixed(1) : '';
            const color = rating >= 4.0 ? '#4CAF50' : (rating >= 3.0 ? '#FFC107' : '#F44336');

            return new style.Style({
                image: new style.Circle({
                    radius: 12,
                    fill: new style.Fill({ color: color }),
                    stroke: new style.Stroke({ color: '#fff', width: 2 })
                }),
                text: new style.Text({
                    text: emoji,
                    font: '14px sans-serif',
                    offsetY: 0,
                    fill: new style.Fill({ color: '#333' })
                })
            });
        }
        
        /**
         * Creates the OpenLayers style for a cluster of markers.
         * @param {Feature} feature - The OpenLayers cluster feature.
         */
        function clusterStyle(feature) {
            const size = feature.get('features').length;
            if (size > 1) {
                return new style.Style({
                    image: new style.Circle({
                        radius: 15,
                        stroke: new style.Stroke({ color: '#fff', width: 2 }),
                        fill: new style.Fill({ color: 'rgba(0, 115, 187, 0.8)' }) // Brand Blue
                    }),
                    text: new style.Text({
                        text: size.toString(),
                        fill: new style.Fill({ color: '#fff' }),
                        font: 'bold 12px sans-serif'
                    })
                });
            } else {
                // Return the style for the single feature within the cluster
                return createBusinessStyle(feature.get('features')[0]);
            }
        }
        
        /**
         * Style for the temporary marker used during business registration.
         */
        function tempMarkerStyle() {
            return new style.Style({
                image: new style.Circle({
                    radius: 10,
                    stroke: new style.Stroke({ color: '#fff', width: 2 }),
                    fill: new style.Fill({ color: 'red' })
                }),
                text: new style.Text({
                    text: 'üìç',
                    font: '16px sans-serif',
                    offsetY: -1,
                })
            });
        }
        
        /**
         * Handles map click event: either setting a registration point or showing a business popup.
         * @param {MapBrowserEvent} evt - The OpenLayers map browser event.
         */
        function handleMapClick(evt) {
            // 1. Check for feature click (Business)
            let featureClicked = false;
            map.forEachFeatureAtPixel(evt.pixel, (feature, layer) => {
                if (feature.get('features')) {
                    // This is a cluster, zoom in
                    const extent = feature.get('features')[0].getGeometry().getExtent();
                    map.getView().fit(extent, {
                        duration: 500,
                        maxZoom: map.getView().getZoom() + 1
                    });
                    featureClicked = true;
                    return; // Stop processing after cluster click
                }
                
                // This is a single business marker
                const businessData = feature.get('businessData');
                if (businessData) {
                    showBusinessPopup(evt.coordinate, businessData);
                    featureClicked = true;
                }
            });
            
            if (featureClicked) return;

            // 2. Set registration coordinates if no feature was clicked
            setRegistrationCoords(evt.coordinate);
        }

        /**
         * Updates the registration form's Lat/Lon fields and sets the temp marker.
         * @param {Coordinate} coordinate - The map coordinate in map projection.
         */
        function setRegistrationCoords(coordinate) {
            const coords4326 = proj.toLonLat(coordinate);
            
            document.getElementById('biz-longitude').value = coords4326[0].toFixed(5);
            document.getElementById('biz-latitude').value = coords4326[1].toFixed(5);
            
            // Clear previous temp marker
            tempVectorLayer.getSource().clear();
            
            // Create new temp marker feature
            tempRegistrationFeature = new Feature({
                geometry: new geom.Point(coordinate)
            });
            tempVectorLayer.getSource().addFeature(tempRegistrationFeature);

            // Ensure registration form is visible
            toggleRegistrationForm(null, 'expand'); 
            
            // Scroll to the registration coordinates inputs
            document.getElementById('registrationSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // --- MAP INITIALIZATION ---
        function initMap() {
            console.log('Initializing OpenLayers map...');
            
            const osmLayer = new layer.Tile({
                title: 'üó∫Ô∏è Street Map',
                visible: true,
                source: new source.OSM()
            });

            const satelliteLayer = new layer.Tile({
                title: 'üõ∞Ô∏è Satellite',
                visible: false,
                source: new source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                })
            });

            vectorSource = new source.Vector();
            clusterSource = new source.Cluster({ 
                distance: 40, // Distance in pixels to group features
                source: vectorSource 
            });

            // The vector layer uses the clusterStyle function which handles single/cluster features
            vectorLayer = new layer.Vector({ 
                title: 'Businesses', 
                source: clusterSource, 
                style: clusterStyle 
            });

            // Layer for temporary marker during registration
            tempVectorLayer = new layer.Vector({ 
                title: 'Registration Point', 
                source: new source.Vector(), 
                style: tempMarkerStyle 
            });


            map = new Map({
                target: 'map',
                layers: [osmLayer, satelliteLayer, vectorLayer, tempVectorLayer],
                view: new View({
                    center: defaultCenter,
                    zoom: ZIMBABWE_INITIAL_ZOOM
                }),
                controls: control.defaults.defaults({
                    zoom: false, // Disable default zoom control
                    rotate: false,
                    attribution: true
                })
            });

            // 1. Zoom Control (Top-Left)
            map.addControl(new control.Zoom({
                target: map.getTarget(), 
                className: 'ol-zoom' 
            }));


            // 2. Layer Switcher (Top-Right)
            const layerSwitcherContainer = document.createElement('div');
            layerSwitcherContainer.className = 'ol-custom-layer-switcher';
            
            const createLayerSwitcher = (layer) => {
                const layerId = `layer-${layer.get('title').replace(/\s/g, '-')}`;
                const label = document.createElement('label');
                label.innerHTML = `<input type="radio" name="base-layer" id="${layerId}" value="${layer.get('title')}"> ${layer.get('title')}`;
                
                const input = label.querySelector('input');
                input.checked = layer.getVisible();

                input.onchange = (e) => {
                    // Hide all base layers (OSM and Satellite)
                    osmLayer.setVisible(false);
                    satelliteLayer.setVisible(false);
                    
                    // Show the selected layer
                    if (e.target.value === 'üó∫Ô∏è Street Map') {
                        osmLayer.setVisible(true);
                    } else if (e.target.value === 'üõ∞Ô∏è Satellite') {
                        satelliteLayer.setVisible(true);
                    }
                };
                layerSwitcherContainer.appendChild(label);
            };

            createLayerSwitcher(osmLayer);
            createLayerSwitcher(satelliteLayer);
            map.addControl(new control.Control({ element: layerSwitcherContainer }));


            // Popup Overlay Setup 
            const popupElement = document.getElementById('popup');
            const closer = document.getElementById('popup-closer');
            const popupOverlay = new Overlay({
                element: popupElement,
                autoPan: true,
                autoPanAnimation: {
                    duration: 250,
                },
            });
            map.addOverlay(popupOverlay);

            closer.onclick = function() {
                popupOverlay.setPosition(undefined);
                closer.blur();
                return false;
            };

            map.on('click', handleMapClick);
        }
        
        /**
         * Displays a popup on the map for a given business.
         * @param {Coordinate} coordinate - The map coordinate for the popup anchor.
         * @param {object} businessData - The business data object.
         */
        function showBusinessPopup(coordinate, businessData) {
            const popupContent = document.getElementById('popup-content');
            const rating = (businessData.avg_rating || 0).toFixed(1);
            const reviewCount = businessData.review_count || 0;

            popupContent.innerHTML = `
                <h4>${businessData.name}</h4>
                <p>Rating: <span class="rating">${rating} ‚≠ê</span> (${reviewCount} reviews)</p>
                <p>${businessData.address}, ${businessData.city}</p>
                <button class="details-button" onclick="window.fetchBusinessDetails('${businessData._id}')">View Details</button>
            `;

            const popupOverlay = map.getOverlayById('popup');
            popupOverlay.setPosition(coordinate);
        }


        // --- DATA RENDERING FUNCTIONS ---
        
        /**
         * Populates the map with features from an array of business data.
         * @param {Array<object>} businesses - List of business data objects.
         */
        function displayBusinessesOnMap(businesses) {
            vectorSource.clear(); // Clear existing markers
            
            const features = businesses.map(business => {
                if (business.location && business.location.longitude && business.location.latitude) {
                    const lonLat = [business.location.longitude, business.location.latitude];
                    
                    const feature = new Feature({
                        geometry: new geom.Point(proj.fromLonLat(lonLat)),
                        // Store the full business data object on the feature
                        businessData: business, 
                        // Add a separate ID property for clustering/identification
                        _id: business._id 
                    });
                    return feature;
                }
                return null;
            }).filter(f => f !== null);

            vectorSource.addFeatures(features);
            
            // Zoom to the extent of the new markers
            if (features.length > 0) {
                 map.getView().fit(vectorSource.getExtent(), {
                     padding: [50, 50, 50, 50],
                     duration: 1000
                 });
            } else {
                 // If no results, reset to default view
                 map.getView().setCenter(defaultCenter);
                 map.getView().setZoom(ZIMBABWE_INITIAL_ZOOM);
            }
        }

        /**
         * Renders the list of businesses in the left panel.
         * @param {Array<object>} businesses - List of business data objects.
         */
        function displayBusinessesInList(businesses) {
            const list = document.getElementById('businessList');
            list.innerHTML = ''; // Clear previous list

            if (businesses.length === 0) {
                list.innerHTML = `
                    <li style="padding: 20px; text-align: center; color: #999; border-left: none;">
                        No businesses found matching your criteria.
                    </li>
                `;
                return;
            }

            businesses.forEach(business => {
                const rating = (business.avg_rating || 0).toFixed(1);
                const reviewCount = business.review_count || 0;
                
                const item = document.createElement('li');
                item.className = 'business-item';
                item.innerHTML = `
                    <h3>${getCategoryEmoji(business.categories)} ${business.name}</h3>
                    <p><strong>Rating:</strong> <span class="rating">${rating} ‚≠ê</span> (${reviewCount} reviews)</p>
                    <p>Address: ${business.address}, ${business.city}</p>
                    <p>Category: ${business.categories}</p>
                    <button class="details-button" onclick="fetchBusinessDetails('${business._id}')">View Details & Reviews</button>
                `;
                list.appendChild(item);
            });
        }
        
        /**
         * Hides the list view and shows the single business details view.
         * @param {object} business - The business data object.
         */
        function showSingleBusinessView(business) {
            document.getElementById('singleBusinessView').style.display = 'block';
            document.getElementById('businessList').parentElement.style.display = 'none';
            document.getElementById('searchForm').parentElement.style.display = 'none';
            document.getElementById('registrationSection').style.display = 'none';
            document.getElementById('fixedAddBusinessBtn').style.display = 'none';


            // Populate details
            document.getElementById('singleBizName').textContent = business.name;
            document.getElementById('singleBizAddress').textContent = `${business.address}, ${business.city}, ${business.state}, ${business.zip_code}`;
            document.getElementById('singleBizCategory').textContent = business.categories;
            document.getElementById('singleBizPhone').textContent = business.phone_number;
            document.getElementById('singleBizRating').textContent = (business.avg_rating || 0).toFixed(1);
            document.getElementById('singleBizReviewCount').textContent = business.review_count || 0;
            document.getElementById('review-business-id').value = business._id;
            
            // Render Reviews
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = '';
            
            if (business.reviews && business.reviews.length > 0) {
                business.reviews.forEach(review => {
                    const item = document.createElement('li');
                    item.className = 'business-item';
                    item.style.borderLeftColor = '#ff9800'; // Orange border for reviews
                    item.innerHTML = `
                        <p><strong>${review.username}</strong> on ${new Date(review.date_submitted.$date).toLocaleDateString()}</p>
                        <p>Rating: <span class="rating">${review.rating} ‚≠ê</span></p>
                        <p>${review.text}</p>
                    `;
                    reviewsList.appendChild(item);
                });
            } else {
                reviewsList.innerHTML = `<li style="padding: 20px; text-align: center; color: #999; border-left: none;">No reviews yet. Be the first!</li>`;
            }
        }
        
        /**
         * Closes the single business view and returns to the search results view.
         */
        function closeSingleView() {
            document.getElementById('singleBusinessView').style.display = 'none';
            document.getElementById('businessList').parentElement.style.display = 'block';
            document.getElementById('searchForm').parentElement.style.display = 'block';
            document.getElementById('registrationSection').style.display = 'block';
            document.getElementById('fixedAddBusinessBtn').style.display = 'block';
            document.getElementById('reviewMessage').style.display = 'none'; // Clear any review message
        }

        // --- API CALLS (Search, Details, Register, Review) ---

        /**
         * Fetches all details and reviews for a specific business ID.
         * @param {string} businessId - The MongoDB ObjectId of the business.
         */
        async function fetchBusinessDetails(businessId) {
            try {
                const response = await fetch(`${API_URL}/businesses/${businessId}`);
                const data = await response.json();
                
                if (response.ok) {
                    showSingleBusinessView(data);
                } else {
                    alert('Error fetching business details: ' + (data.error || 'Unknown error'));
                    console.error('Error details:', data);
                }
            } catch (error) {
                alert('Network error while fetching business details. Check server connection.');
                console.error('Fetch Details Error:', error);
            }
        }


        // --- EVENT HANDLERS ---
        
        // Handle Business Search Form Submission
        document.getElementById('searchForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const searchTerm = document.getElementById('search-term').value;
            const cityFilter = document.getElementById('city-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const resultsMessage = document.getElementById('resultsMessage');
            
            // Close single view if it was open
            closeSingleView();

            try {
                const queryParams = new URLSearchParams({
                    search: searchTerm,
                    city: cityFilter,
                    category: categoryFilter
                });
                
                const response = await fetch(`${API_URL}/businesses?${queryParams.toString()}`);
                const data = await response.json();

                if (response.ok && data.businesses) {
                    displayBusinessesOnMap(data.businesses);
                    displayBusinessesInList(data.businesses);
                    
                    resultsMessage.textContent = `Found ${data.businesses.length} businesses.`;
                    resultsMessage.className = 'message success';
                    resultsMessage.style.display = 'block';
                    
                } else {
                    displayBusinessesOnMap([]);
                    displayBusinessesInList([]);
                    
                    resultsMessage.textContent = '‚ùå ' + (data.error || 'Failed to fetch search results.');
                    resultsMessage.className = 'message error';
                    resultsMessage.style.display = 'block';
                }
            } catch (error) {
                displayBusinessesOnMap([]);
                displayBusinessesInList([]);
                resultsMessage.textContent = '‚ùå Network error. Check your backend server connection.';
                resultsMessage.className = 'message error';
                resultsMessage.style.display = 'block';
                console.error('Search Error:', error);
            }
        });

        // Handle Business Registration Form Submission
        document.getElementById('registerBusinessForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const registerBtn = document.getElementById('registerBtn');
            if (registerBtn.disabled) return;
            registerBtn.disabled = true;

            const registrationData = {
                name: document.getElementById('biz-name').value,
                address: document.getElementById('biz-address').value,
                city: document.getElementById('biz-city').value,
                state: document.getElementById('biz-state').value,
                zip_code: document.getElementById('biz-zip').value,
                categories: document.getElementById('biz-category').value,
                phone_number: document.getElementById('biz-phone').value,
                latitude: parseFloat(document.getElementById('biz-latitude').value),
                longitude: parseFloat(document.getElementById('biz-longitude').value)
            };

            // Basic validation
            if (isNaN(registrationData.latitude) || isNaN(registrationData.longitude)) {
                 displayMessage('resultsMessage', 'error', '‚ùå Please click on the map to set a valid location.');
                 registerBtn.disabled = false;
                 return;
            }

            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`${API_URL}/businesses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(registrationData)
                });

                const data = await response.json();
                registerBtn.disabled = false;

                if (response.ok) {
                    displayMessage('resultsMessage', 'success', `‚úÖ Business "${registrationData.name}" registered successfully!`);
                    
                    // Clear the form and temp marker
                    this.reset(); 
                    tempVectorLayer.getSource().clear();
                    toggleRegistrationForm(null, 'collapse');
                    
                    // Trigger a search to refresh the list and map
                    document.getElementById('searchForm').dispatchEvent(new Event('submit')); 

                } else {
                    displayMessage('resultsMessage', 'error', '‚ùå ' + (data.error || 'Failed to register business.'));
                }
            } catch (error) {
                registerBtn.disabled = false;
                displayMessage('resultsMessage', 'error', '‚ùå Network error during registration. Check your backend server.');
                console.error('Registration Error:', error);
            }
        });
        
        // Handle Review Submission Form
        document.getElementById('submitReviewForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const reviewData = {
                business_id: document.getElementById('review-business-id').value,
                rating: parseInt(document.getElementById('review-rating').value, 10),
                text: document.getElementById('review-text').value,
            };

            // Basic validation
            if (reviewData.rating < 1 || reviewData.rating > 5) {
                displayMessage('reviewMessage', 'error', '‚ùå Rating must be between 1 and 5.');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                
                const response = await fetch(`${API_URL}/reviews`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(reviewData)
                });

                const data = await response.json();

                if (response.ok) {
                    displayMessage('reviewMessage', 'success', 
                        `‚úÖ Review posted! New average rating: ${parseFloat(data.new_avg_rating).toFixed(1)} ‚≠ê`);
                    this.reset();
                    
                    setTimeout(() => {
                        // Re-fetch details to refresh the review list and rating
                        fetchBusinessDetails(reviewData.business_id);
                    }, 500);
                } else {
                    displayMessage('reviewMessage', 'error', '‚ùå ' + (data.error || 'Failed to submit review.'));
                }
            } catch (error) {
                displayMessage('reviewMessage', 'error', '‚ùå Network error during review submission. Check your backend server.');
                console.error('Review Submission Error:', error);
            }
        });


        // --- INITIALIZE ON LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            checkAuthAndDisplay();
            
            initMap(); 
            
            // Set initial state to collapsed for cleaner startup
            toggleRegistrationForm(null, 'collapse');
            
            // FIX: Automatically trigger a search on page load to populate the business list and the map
            // An empty search fetches all businesses and calls displayBusinessesOnMap/displayBusinessesInList.
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.dispatchEvent(new Event('submit')); 
            }
        });

        // Make functions globally accessible for HTML onclick attributes
        window.fetchBusinessDetails = fetchBusinessDetails;
        window.closeSingleView = closeSingleView;
    </script>

</body>
</html>